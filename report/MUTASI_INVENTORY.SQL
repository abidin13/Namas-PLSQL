SELECT PPP.*,
       ROUND(PPP.CROSCHEK - PPP.BEG_END_COST,2) AS SELISIH
       
FROM
(
SELECT  pp.INVENTORY_ITEM_ID,
        PP.ITEMCODE, PP.ITEM_DESC, PP.NP_GL_CLASS_CATEGORY, PP.NP_PRODUCT_CATEGORY, PP.BEG_BALANCE_QTY, PP.BEG_BALANCE_COST, PP.BEG_BALANCE_QTY * PP.BEG_BALANCE_COST AS BEG_BALANCE_AMOUNT,
        PP.AMOUNT_ACTCOSTADJ, PP.AMOUNT_GLCOSTALOC, PP.AMOUNT_INVOICEIPVADJ, PP.AMOUNT_INVOICEERVADJ, PP.QTY_CERT, PP.AMOUNT_CERT, PP.QTY_MISC, PP.AMOUNT_MISC, PP.QTY_PO,
        PP.AMOUNT_PO, PP.QTY_RMA, PP.AMOUNT_RMA, 
        
        PP.QTY_MISC_ISSUE,  
        PP.AMOUNT_MISC_ISSUE, 
        
        PP.QTY_MOVE_ORDER_ISSUE, 
        PP.AMOUNT_MOVE_ORDER_ISSUE,
        
        PP.QTY_RELE,
        PP.AMOUNT_RELE,
        
        PP.QTY_RET_TO_RECEIVING,
        PP.AMOUNT_RET_TO_RECEIVING,
        
        PP.QTY_SO_ISSUE,
        PP.AMOUNT_SO_ISSUE,
        
        (PP.BEG_BALANCE_QTY + PP.QTY_CERT + PP.QTY_MISC + PP.QTY_PO + PP.QTY_RMA + PP.QTY_MISC_ISSUE + PP.QTY_MOVE_ORDER_ISSUE + PP.QTY_RELE + PP.QTY_RET_TO_RECEIVING + PP.QTY_SO_ISSUE) AS END_QTY,
        
        CASE WHEN (((PP.BEG_BALANCE_QTY * PP.BEG_BALANCE_COST) + (PP.AMOUNT_ACTCOSTADJ + PP.AMOUNT_GLCOSTALOC + PP.AMOUNT_INVOICEIPVADJ + PP.AMOUNT_INVOICEERVADJ + PP.AMOUNT_CERT + PP.AMOUNT_MISC + PP.AMOUNT_PO + PP.AMOUNT_RMA +PP.AMOUNT_MISC_ISSUE + PP.AMOUNT_MOVE_ORDER_ISSUE + PP.AMOUNT_RELE + PP.AMOUNT_RET_TO_RECEIVING + PP.AMOUNT_SO_ISSUE)) > 0) AND ((PP.BEG_BALANCE_QTY + PP.QTY_CERT + PP.QTY_MISC + PP.QTY_PO + PP.QTY_RMA + PP.QTY_MISC_ISSUE + PP.QTY_MOVE_ORDER_ISSUE + PP.QTY_RELE + PP.QTY_RET_TO_RECEIVING + PP.QTY_SO_ISSUE) > 0) THEN
                 ((PP.BEG_BALANCE_QTY * PP.BEG_BALANCE_COST) + (PP.AMOUNT_ACTCOSTADJ + PP.AMOUNT_GLCOSTALOC + PP.AMOUNT_INVOICEIPVADJ + PP.AMOUNT_INVOICEERVADJ + PP.AMOUNT_CERT + PP.AMOUNT_MISC + PP.AMOUNT_PO + PP.AMOUNT_RMA +PP.AMOUNT_MISC_ISSUE + PP.AMOUNT_MOVE_ORDER_ISSUE + PP.AMOUNT_RELE + PP.AMOUNT_RET_TO_RECEIVING + PP.AMOUNT_SO_ISSUE)) / ((PP.BEG_BALANCE_QTY + PP.QTY_CERT + PP.QTY_MISC + PP.QTY_PO + PP.QTY_RMA + PP.QTY_MISC_ISSUE + PP.QTY_MOVE_ORDER_ISSUE + PP.QTY_RELE + PP.QTY_RET_TO_RECEIVING + PP.QTY_SO_ISSUE)) 
        ELSE
            0
        END AS BEG_END_COST,
        (PP.BEG_BALANCE_QTY * PP.BEG_BALANCE_COST) + (PP.AMOUNT_ACTCOSTADJ + PP.AMOUNT_GLCOSTALOC + PP.AMOUNT_INVOICEIPVADJ + PP.AMOUNT_INVOICEERVADJ + PP.AMOUNT_CERT + PP.AMOUNT_MISC + PP.AMOUNT_PO + PP.AMOUNT_RMA +PP.AMOUNT_MISC_ISSUE + PP.AMOUNT_MOVE_ORDER_ISSUE + PP.AMOUNT_RELE + PP.AMOUNT_RET_TO_RECEIVING + PP.AMOUNT_SO_ISSUE) AS END_AMOUNT,

        PP.DES AS CROSCHEK
               
FROM
(
SELECT  A.INVENTORY_ITEM_ID,
        A.SEGMENT1 || '-' || A.SEGMENT2 || '-' ||  A.SEGMENT3 || '-' || A.SEGMENT4 || '-' || A.SEGMENT5 AS ITEMCODE,
        A.DESCRIPTION AS ITEM_DESC,
        (
         SELECT MIC.SEGMENT1
         FROM   MTL_ITEM_CATEGORIES_V MIC
         WHERE  MIC.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    MIC.ORGANIZATION_ID = A.ORGANIZATION_ID
         AND    MIC.CATEGORY_SET_ID = 1100000041
        ) AS NP_GL_CLASS_CATEGORY,
        (
         SELECT MIC.SEGMENT1
         FROM   MTL_ITEM_CATEGORIES_V MIC
         WHERE  MIC.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    MIC.ORGANIZATION_ID = A.ORGANIZATION_ID
         AND    MIC.CATEGORY_SET_ID = 1100000042
        ) AS NP_PRODUCT_CATEGORY,
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE IN ('CERT','MISC_RECEIPT','PO_RECEIPT','RMA_RECEIPT','MISC_ISSUE','MOVE_ORDER_ISSUE','RELE','RET_TO_RECEIVING','SO_ISSUE')
         AND    TRUNC(AA.TRANSACTION_DATE) < TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') 
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS BEG_BALANCE_QTY,
        
        YNPCM_INV_COST_BEG(A.INVENTORY_ITEM_ID,:p_from_date,:P_IO) AS BEG_BALANCE_COST,
        
        (
        SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
        FROM   GMF_XLA_EXTRACT_HEADERS AA
        WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
        AND    AA.EVENT_TYPE_CODE = 'ACTCOSTADJ'
        AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(:p_to_date,'RRRR/MM/DD HH24:MI:SS')
        AND    AA.ORGANIZATION_ID = (SELECT OOD.ORGANIZATION_ID FROM ORG_ORGANIZATION_DEFINITIONS OOD
                                    WHERE OOD.OPERATING_UNIT = (
                                                                SELECT AAA.OPERATING_UNIT FROM ORG_ORGANIZATION_DEFINITIONS AAA
                                                                WHERE AAA.ORGANIZATION_ID = :P_IO
                                                               )
                                    AND SUBSTR(OOD.ORGANIZATION_CODE,-1,1) = 'C'
                                   )
        ) AS AMOUNT_ACTCOSTADJ,
        (
        SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
        FROM   GMF_XLA_EXTRACT_HEADERS AA
        WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
        AND    AA.EVENT_TYPE_CODE = 'GLCOSTALOC'
        AND    trunc(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
        AND    AA.ORGANIZATION_ID = (SELECT OOD.ORGANIZATION_ID FROM ORG_ORGANIZATION_DEFINITIONS OOD
                                    WHERE OOD.OPERATING_UNIT = (
                                                                SELECT AAA.OPERATING_UNIT FROM ORG_ORGANIZATION_DEFINITIONS AAA
                                                                WHERE AAA.ORGANIZATION_ID = :P_IO
                                                               )
                                    AND SUBSTR(OOD.ORGANIZATION_CODE,-1,1) = 'C'
                                   )
        ) AS AMOUNT_GLCOSTALOC,
        (
        SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
        FROM   GMF_XLA_EXTRACT_HEADERS AA
        WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
        AND    AA.EVENT_TYPE_CODE = 'INVOICE_IPV_ADJ'
        AND    trunc(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
        AND    AA.ORGANIZATION_ID = (SELECT OOD.ORGANIZATION_ID FROM ORG_ORGANIZATION_DEFINITIONS OOD
                                    WHERE OOD.OPERATING_UNIT = (
                                                                SELECT AAA.OPERATING_UNIT FROM ORG_ORGANIZATION_DEFINITIONS AAA
                                                                WHERE AAA.ORGANIZATION_ID = :P_IO
                                                               )
                                    AND SUBSTR(OOD.ORGANIZATION_CODE,-1,1) = 'C'
                                   )
        ) AS AMOUNT_INVOICEIPVADJ,
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'INVOICE_ERV_ADJ'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = (SELECT OOD.ORGANIZATION_ID FROM ORG_ORGANIZATION_DEFINITIONS OOD
                                      WHERE OOD.OPERATING_UNIT = (
                                                                  SELECT AAA.OPERATING_UNIT FROM ORG_ORGANIZATION_DEFINITIONS AAA
                                                                  WHERE AAA.ORGANIZATION_ID = :P_IO
                                                                 )
                                      AND SUBSTR(OOD.ORGANIZATION_CODE,-1,1) = 'C'
                                     )
        ) AS AMOUNT_INVOICEERVADJ,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'CERT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_CERT,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'CERT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_CERT,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'MISC_RECEIPT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_MISC,
        
        (TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'MISC_RECEIPT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_MISC,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'PO_RECEIPT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_PO,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'PO_RECEIPT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_PO,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'RMA_RECEIPT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_RMA,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'RMA_RECEIPT'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_RMA,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'MISC_ISSUE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_MISC_ISSUE,
        
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'MISC_ISSUE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_MISC_ISSUE, 
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'MOVE_ORDER_ISSUE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_MOVE_ORDER_ISSUE,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'MOVE_ORDER_ISSUE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_MOVE_ORDER_ISSUE,    
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'RELE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_RELE,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'RELE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_RELE,   
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'RET_TO_RECEIVING'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_RET_TO_RECEIVING,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'RET_TO_RECEIVING'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_RET_TO_RECEIVING,  
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_QUANTITY),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'SO_ISSUE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS QTY_SO_ISSUE,
        
        (
         SELECT NVL(SUM(AA.TRANSACTION_VALUE),0) 
         FROM   GMF_XLA_EXTRACT_HEADERS AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.EVENT_TYPE_CODE = 'SO_ISSUE'
         AND    TRUNC(AA.TRANSACTION_DATE) BETWEEN TO_DATE(:p_from_date,'RRRR/MM/DD HH24:MI:SS') AND TO_DATE(substr(:p_to_date,1,10)||'23:59:59','RRRR/MM/DD HH24:MI:SS')
         AND    AA.ORGANIZATION_ID = :P_IO
        ) AS AMOUNT_SO_ISSUE,  
        
        (
         SELECT NVL(SUM(AA.CMPNT_COST),0)
         FROM   CM_CMPT_DTL AA
         WHERE  AA.INVENTORY_ITEM_ID = A.INVENTORY_ITEM_ID
         AND    AA.COST_TYPE_ID = 1000
         AND    PERIOD_ID = (SELECT PERIOD_ID 
                             FROM   GMF_PERIOD_STATUSES 
                             WHERE  COST_TYPE_ID = 1000 
                             AND    LEGAL_ENTITY_ID = (SELECT LEGAL_ENTITY FROM ORG_ORGANIZATION_DEFINITIONS 
                                                       WHERE ORGANIZATION_ID = :P_IO)
                             AND    START_DATE = trunc(to_date(:p_to_date,'RRRR/MM/DD HH24:MI:SS'),'MM')
                             --AND    TO_CHAR(START_DATE, 'MM') = 1
                             --AND    TO_CHAR(START_DATE, 'YYYY') = 2015
                            )
         AND   ORGANIZATION_ID = (SELECT OOD.ORGANIZATION_ID FROM ORG_ORGANIZATION_DEFINITIONS OOD
                                WHERE OOD.OPERATING_UNIT = ( SELECT A.OPERATING_UNIT FROM ORG_ORGANIZATION_DEFINITIONS A WHERE A.ORGANIZATION_ID = :P_IO)
                                AND SUBSTR(OOD.ORGANIZATION_CODE,-1,1) = 'C')
        ) AS DES
        
        
FROM   MTL_SYSTEM_ITEMS A
WHERE  A.ORGANIZATION_ID = :P_IO
AND    A.INVENTORY_ITEM_ID IN (SELECT DISTINCT INVENTORY_ITEM_ID FROM GMF_XLA_EXTRACT_HEADERS WHERE ORGANIZATION_ID = :P_IO AND TRANSACTION_DATE <= TRUNC(to_date(:p_to_date,'RRRR/MM/DD HH24:MI:SS')))
)PP
WHERE ITEMCODE = 'FGP-RPT-ER2XXX-XXX-002'
)PPP






